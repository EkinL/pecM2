name: iOS CD (TestFlight)

on:
  push:
    branches: [main]
    paths:
      - "mobile/**"
      - ".github/workflows/ios-cd.yml"
  workflow_dispatch:

concurrency:
  group: ios-testflight
  cancel-in-progress: false

jobs:
  deploy:
    name: Build and Upload to TestFlight
    runs-on: macos-15
    timeout-minutes: 60
    defaults:
      run:
        working-directory: mobile
    env:
      CI: true
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      APP_IDENTIFIER: com.lilian.pecm2
      MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
      MATCH_GIT_BRANCH: ${{ vars.MATCH_GIT_BRANCH || 'master' }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install gems
        run: bundle install

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Upload to TestFlight
        run: bundle exec fastlane ios beta
